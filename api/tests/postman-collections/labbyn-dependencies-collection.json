{
	"info": {
		"name": "Labbyn ULTIMATE - Full Security & RBAC Flow",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "1. GLOBAL SETUP (Service Admin)",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"const ts = Date.now().toString().slice(-4);",
							"pm.environment.set('uid', ts);"
						]
					}
				}
			],
			"item": [
				{
					"name": "1.1 Login SuperAdmin",
					"event": [{ "listen": "test", "script": { "exec": ["pm.environment.set('token_service', pm.response.json().access_token);"] } }],
					"request": {
						"method": "POST",
						"body": { "mode": "urlencoded", "urlencoded": [{ "key": "username", "value": "Service", "type": "text" }, { "key": "password", "value": "Service", "type": "text" }] },
						"url": "{{base_url}}/auth/login"
					}
				},
				{
					"name": "1.2 Create Team Alpha",
					"event": [{ "listen": "test", "script": { "exec": ["pm.environment.set('team_alpha_id', pm.response.json().id);"] } }],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_service}}", "type": "string" }] },
						"method": "POST",
						"body": { "mode": "raw", "raw": "{\"name\": \"Team Alpha {{uid}}\", \"team_admin_id\": 1}", "options": { "raw": { "language": "json" } } },
						"url": "{{base_url}}/db/teams/"
					}
				},
				{
					"name": "1.3 Create Team Beta",
					"event": [{ "listen": "test", "script": { "exec": ["pm.environment.set('team_beta_id', pm.response.json().id);"] } }],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_service}}", "type": "string" }] },
						"method": "POST",
						"body": { "mode": "raw", "raw": "{\"name\": \"Team Beta {{uid}}\", \"team_admin_id\": 1}", "options": { "raw": { "language": "json" } } },
						"url": "{{base_url}}/db/teams/"
					}
				}
			]
		},
		{
			"name": "2. ADMIN ALPHA FLOW",
			"item": [
				{
					"name": "2.1 Create Admin Alpha",
					"event": [{ "listen": "test", "script": { "exec": ["var res = pm.response.json(); pm.environment.set('pass_start_alpha', res.generated_password); pm.environment.set('login_alpha', res.login);"] } }],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_service}}", "type": "string" }] },
						"method": "POST",
						"body": { "mode": "raw", "raw": "{\"login\": \"alpha_{{uid}}\", \"email\": \"alpha_{{uid}}@lab.pl\", \"user_type\": \"group_admin\", \"team_id\": {{team_alpha_id}}, \"name\": \"Adam\", \"surname\": \"Alpha\"}", "options": { "raw": { "language": "json" } } },
						"url": "{{base_url}}/db/users/"
					}
				},
				{
					"name": "2.2 Login Alpha & Set Password",
					"event": [{ "listen": "test", "script": { "exec": ["pm.environment.set('token_alpha', pm.response.json().access_token);"] } }],
					"request": {
						"method": "POST",
						"body": { "mode": "urlencoded", "urlencoded": [{ "key": "username", "value": "{{login_alpha}}", "type": "text" }, { "key": "password", "value": "{{pass_start_alpha}}", "type": "text" }] },
						"url": "{{base_url}}/auth/login"
					}
				},
				{
					"name": "2.3 Alpha Creates Machine",
					"event": [{ "listen": "test", "script": { "exec": ["pm.environment.set('machine_alpha_id', pm.response.json().id);"] } }],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_alpha}}", "type": "string" }] },
						"method": "POST",
						"body": { "mode": "raw", "raw": "{\"name\": \"ALPHA-SECURE-SRV\", \"localization_id\": 1, \"metadata_id\": 1}", "options": { "raw": { "language": "json" } } },
						"url": "{{base_url}}/db/machines/"
					}
				}
			]
		},
		{
			"name": "3. ADMIN BETA ATTACK (Cross-Team)",
			"item": [
				{
					"name": "3.1 Create Admin Beta",
					"event": [{ "listen": "test", "script": { "exec": ["var res = pm.response.json(); pm.environment.set('pass_start_beta', res.generated_password); pm.environment.set('login_beta', res.login);"] } }],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_service}}", "type": "string" }] },
						"method": "POST",
						"body": { "mode": "raw", "raw": "{\"login\": \"beta_{{uid}}\", \"email\": \"beta_{{uid}}@lab.pl\", \"user_type\": \"group_admin\", \"team_id\": {{team_beta_id}}, \"name\": \"Bartosz\", \"surname\": \"Beta\"}", "options": { "raw": { "language": "json" } } },
						"url": "{{base_url}}/db/users/"
					}
				},
				{
					"name": "3.2 Login Beta",
					"event": [{ "listen": "test", "script": { "exec": ["pm.environment.set('token_beta', pm.response.json().access_token);"] } }],
					"request": {
						"method": "POST",
						"body": { "mode": "urlencoded", "urlencoded": [{ "key": "username", "value": "{{login_beta}}", "type": "text" }, { "key": "password", "value": "{{pass_start_beta}}", "type": "text" }] },
						"url": "{{base_url}}/auth/login"
					}
				},
				{
					"name": "3.3 ATTACK: Beta hits Alpha Machine ID",
					"event": [{ "listen": "test", "script": { "exec": ["pm.test('ISOLATION OK: Should be 404 or 403', function() { pm.expect(pm.response.code).to.be.oneOf([403, 404]); });"] } }],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_beta}}", "type": "string" }] },
						"method": "GET",
						"url": "{{base_url}}/db/machines/{{machine_alpha_id}}"
					}
				}
			]
		},
		{
			"name": "4. SIMPLE USER ATTACK (RBAC)",
			"item": [
				{
					"name": "4.1 Create Simple User (Team Alpha)",
					"event": [{ "listen": "test", "script": { "exec": ["var res = pm.response.json(); pm.environment.set('pass_user', res.generated_password); pm.environment.set('login_user', res.login);"] } }],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_service}}", "type": "string" }] },
						"method": "POST",
						"body": { "mode": "raw", "raw": "{\"login\": \"user_{{uid}}\", \"email\": \"u_{{uid}}@lab.pl\", \"user_type\": \"user\", \"team_id\": {{team_alpha_id}}, \"name\": \"Ula\", \"surname\": \"User\"}", "options": { "raw": { "language": "json" } } },
						"url": "{{base_url}}/db/users/"
					}
				},
				{
					"name": "4.2 Login Simple User",
					"event": [{ "listen": "test", "script": { "exec": ["pm.environment.set('token_user', pm.response.json().access_token);"] } }],
					"request": {
						"method": "POST",
						"body": { "mode": "urlencoded", "urlencoded": [{ "key": "username", "value": "{{login_user}}", "type": "text" }, { "key": "password", "value": "{{pass_user}}", "type": "text" }] },
						"url": "{{base_url}}/auth/login"
					}
				},
				{
					"name": "4.3 RBAC ATTACK: User tries Delete Team",
					"event": [{ "listen": "test", "script": { "exec": ["pm.test('RBAC OK: Should be 403 Forbidden', function() { pm.response.to.have.status(403); });"] } }],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_user}}", "type": "string" }] },
						"method": "DELETE",
						"url": "{{base_url}}/db/teams/{{team_alpha_id}}"
					}
				}
			]
		}
	],
	"variable": [
		{ "key": "base_url", "value": "http://localhost:8000", "type": "string" }
	]
}